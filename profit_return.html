<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Profit Analytics - Final Version</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js for rendering Markdown from Gemini -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>
<body>
<style>
/* --- ROOT VARIABLES & FONT IMPORT --- */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e67e22;
    --light-bg: #ecf0f1;
    --text-dark: #2c3e50;
    --text-light: #7f8c8d;
    --positive-color: #27ae60;
    --negative-color: #c0392b;
    --warning-color: #f39c12;
    --card-bg: #ffffff;
    --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
    --border-color: #dfe6e9;
    --modal-bg: rgba(44, 62, 80, 0.7);
    --gradient-header: linear-gradient(90deg, #2c3e50, #34495e);
    --details-btn-bg: #27ae60;
    --details-btn-text: #ffffff;
    --ai-btn-bg: #8e44ad;
    --ai-btn-text: #ffffff;
}

/* --- BASE & UTILITIES --- */
body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; padding-top: 70px; }
.container { max-width: 1300px; margin: 25px auto; padding: 0 20px; }
.hidden { display: none !important; }
.visually-hidden { opacity: 0; pointer-events: none; visibility: hidden; }
.highlight { font-weight: 700; padding: 2px 6px; border-radius: 5px; }
.highlight.high { background-color: rgba(39, 174, 96, 0.15); color: var(--positive-color); }
.highlight.medium { background-color: rgba(52, 152, 219, 0.15); color: var(--secondary-color); }
.highlight.low { background-color: rgba(243, 156, 18, 0.15); color: var(--warning-color); }
.btn-details-small, .btn-ai-small { background-color: var(--details-btn-bg); color: var(--details-btn-text); padding: 5px 10px; font-size: 0.8em; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; font-weight: 600; border: none; margin-left: 8px; }
.btn-ai-small { background-color: var(--ai-btn-bg); }
.btn-details-small:hover, .btn-ai-small:hover { opacity: 0.85; transform: scale(1.05); }
.button-group { display: flex; align-items: center; justify-content: center; }

/* --- LOADER & PASSWORD PROMPT --- */
#loader, #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 5000; transition: opacity 0.5s ease; flex-direction: column; }
#loader { background-color: var(--light-bg); }
#loader .spinner, .ai-loader .spinner { width: 50px; height: 50px; border: 5px solid rgba(0,0,0,0.1); border-left-color: var(--secondary-color); border-radius: 50%; animation: spin 1.2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#passwordPromptContainer { background-color: var(--modal-bg); backdrop-filter: blur(5px); }
#passwordPromptContainer.visually-hidden { opacity: 0; }
#passwordPromptMessage { padding: 30px 35px; background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; max-width: 340px; width: 90%; }
#passwordPromptMessage h3 { margin-top: 0; font-size: 1.3em; }
#passwordInput { width: calc(100% - 24px); padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 22px; text-align: center; letter-spacing: 10px; font-family: 'Poppins', sans-serif; }
#passwordSubmit { width: 100%; padding: 12px 20px; font-size: 1em; font-weight: 600; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
#passwordSubmit:hover { background-color: var(--secondary-color); transform: translateY(-2px); }

/* --- HEADER & FILTERS --- */
.header { text-align: center; background: var(--gradient-header); color: white; padding: 15px 0; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
.header h1 { font-size: 1.4em; margin: 0; font-weight: 600; }
.filters { margin-bottom: 30px; background-color: var(--card-bg); padding: 15px 20px; border-radius: 12px; box-shadow: var(--card-shadow); }
.filter-group { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
.filter-group label { font-weight: 500; }
.filter-group select { padding: 10px 15px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: white; font-family: 'Poppins', sans-serif; cursor: pointer; flex-grow: 1; }
.rank-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; }
.rank-buttons button { flex-grow: 1; padding: 10px 15px; font-size: 0.9em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
.rank-buttons button i { margin-right: 8px; }
.btn-profit { background-color: var(--accent-color); color: white; }
.btn-score { background-color: var(--secondary-color); color: white; }
.btn-eligibility { background-color: #8e44ad; color: white; }
.rank-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

/* --- MAIN CONTENT & SECTIONS --- */
.main-content { display: grid; grid-template-columns: 1fr; gap: 30px; align-items: flex-start; }
#dashboardContent { opacity: 0; transition: opacity 0.5s ease-in-out; }
#dashboardContent.visible { opacity: 1; }
.content-section { background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); padding: 25px; margin-bottom: 30px;}
.content-section h2 { margin-top: 0; text-align: center; color: var(--primary-color); }
#growthChartContainer { position: relative; height: 350px; }

/* --- PROFILE CARD --- */
.profile-card { border-top: 4px solid var(--secondary-color); }
.profile-image-container { width: 130px; height: 130px; margin: 0 auto 15px auto; border-radius: 50%; overflow: hidden; border: 5px solid var(--light-bg); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
.profile-image-container img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s ease; }
.profile-image-container img:hover { transform: scale(1.05); }
.profile-card h2 { margin: 10px 0 20px 0; font-size: 1.8em; color: var(--primary-color); word-break: break-word; }
.profile-stats { margin-top: 20px; text-align: left; }
.stat-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); font-size: 1em; }
.stat-item:last-child { border-bottom: none; }
.stat-item .label { font-weight: 500; color: var(--text-light); display: flex; align-items: center; gap: 10px; }
.stat-item .label i { width: 20px; text-align: center; }
.stat-item .value { font-weight: 700; font-size: 1.1em; }
.value.positive { color: var(--positive-color); }
.value.negative { color: var(--negative-color); }
.icon-loan { color: var(--negative-color); }
.icon-capital { color: var(--primary-color); }
.icon-profit { color: var(--accent-color); }
.icon-score { color: var(--secondary-color); }
.icon-limit { color: #8e44ad; }

/* --- TABLES (PROFIT, HISTORY, RANKING) --- */
.table-container { width: 100%; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: center; vertical-align: middle; }
th { background-color: var(--primary-color); color: white; font-size: 0.9em; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
td { font-size: 0.95em; }
.profit-value { font-weight: bold; color: var(--positive-color); }
.details-btn { padding: 8px 14px; font-size: 0.85em; background-color: var(--secondary-color); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
.details-btn:hover { background-color: #2980b9; transform: scale(1.05); }
.no-data-row td { text-align: center; padding: 50px; color: var(--text-light); font-size: 1.1em; }
.transaction-type { font-weight: bold; }
.transaction-type.sip { color: var(--positive-color); }
.transaction-type.loan { color: var(--negative-color); }
.transaction-type.payment { color: var(--secondary-color); }

/* --- MODALS --- */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; box-sizing: border-box; transition: opacity 0.3s ease, visibility 0.3s ease; }
.modal-content { background-color: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: var(--card-shadow); max-width: 700px; width: 95%; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
.modal.visually-hidden { opacity: 0; visibility: hidden; }
.modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 30px; color: #bdc3c7; cursor: pointer; transition: color 0.2s; z-index: 2510;}
.modal-close:hover { color: var(--text-dark); }
.modal h2 { margin-top: 0; text-align: center; color: var(--primary-color); font-weight: 600; }
.modal .list-container { overflow-y: auto; flex-grow: 1; }
.modal ul, .modal ol { list-style: none; padding: 0; margin-top: 15px; }
.modal li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; background-color: var(--light-bg); transition: background-color 0.2s; }
.modal li:hover { background-color: #dfe6e9; }
.modal .rank { font-weight: bold; color: var(--secondary-color); min-width: 35px; font-size: 1.1em; }
.modal .name { font-weight: 600; flex-grow: 1; }
.modal .share { font-weight: bold; color: var(--positive-color); white-space: nowrap; }
.chart-container { margin-bottom: 20px; }
.list-header { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); font-size: 1.1em; color: var(--text-light); }
#imageModal .modal-content { background: transparent; padding: 0; box-shadow: none; max-width: 90vw; }
#imageModal img { max-height: 85vh; width: auto; object-fit: contain; border-radius: 12px; }
#imageModal .modal-close { color: white; background-color: rgba(0,0,0,0.4); border-radius: 50%; width: 35px; height: 35px; line-height: 35px; font-size: 22px; text-align: center; top: 20px; right: 20px; }
#calculationDetailsContent { font-size: 0.95em; line-height: 1.8; }
#calculationDetailsContent .calc-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
#calculationDetailsContent .calc-row:last-child { border-bottom: none; }
#calculationDetailsContent .calc-label { color: var(--text-light); }
#calculationDetailsContent .calc-value { font-weight: 600; }
#calculationDetailsContent .calc-formula { font-size: 0.85em; color: var(--text-light); text-align: right; margin-top: -5px; }
#calculationDetailsContent .calc-final { font-size: 1.2em; font-weight: 700; color: var(--positive-color); text-align: center; margin-top: 15px; padding: 10px; background-color: var(--light-bg); border-radius: 8px; }
.improvement-tips { margin-top: 20px; padding: 15px; background-color: rgba(39, 174, 96, 0.05); border: 1px solid rgba(39, 174, 96, 0.2); border-radius: 8px; color: #218c52; }
.improvement-tips h4 { margin-top: 0; }
.improvement-tips ul { padding-left: 20px; margin-bottom: 0; }

/* --- AI MODAL STYLES --- */
#aiExplainModal .modal-content { max-width: 800px; }
#aiExplainModal h2 { display: flex; align-items: center; justify-content: center; gap: 10px; }
#aiExplanationContainer { margin-top: 15px; display: flex; flex-direction: column; gap: 15px; }
#aiExplanationResult { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; min-height: 200px; max-height: 60vh; overflow-y: auto; line-height: 1.7; color: var(--text-dark); }
#aiExplanationResult h3 { margin-top: 0; }
#aiExplanationResult ul { padding-left: 20px; }
#aiExplanationResult strong { color: var(--primary-color); }
.ai-loader { text-align: center; padding: 40px 0; }
.ai-loader .spinner { margin: 0 auto 15px auto; }
.ai-loader span { font-size: 1.1em; color: var(--text-light); }
#languageToggleContainer { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 10px; }
.lang-btn { background: none; border: 1px solid var(--border-color); padding: 4px 8px; font-size: 0.8em; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
.lang-btn:hover { background-color: var(--border-color); }

/* --- RESPONSIVE DESIGN --- */
@media (min-width: 992px) { .main-content { grid-template-columns: 380px 1fr; } .profile-card { position: sticky; top: 100px; } }
@media (max-width: 991px) { .profile-card { margin-bottom: 30px; } }
@media (max-width: 600px) { body { padding-top: 60px; } .container { padding: 0 15px; } .header h1 { font-size: 1.2em; } .filter-group { flex-direction: column; align-items: stretch; } .rank-buttons { flex-direction: column; } .profile-card h2 { font-size: 1.5em; } th, td { padding: 12px 8px; } .modal-content { padding: 20px; } #growthChartContainer { height: 300px; } }
</style>
    <div id="loader">
        <div class="spinner"></div>
        <span>Loading Final Analytics...</span>
    </div>

    <div id="passwordPromptContainer">
        <div id="passwordPromptMessage">
            <h3><i class="fas fa-lock"></i> Enter Access PIN</h3>
            <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="••••">
            <button id="passwordSubmit">Enter</button>
        </div>
    </div>

    <div id="dashboardContent" class="visually-hidden">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Bank Loan Profit</h1>
        </header>

        <div class="container">
            <div class="filters">
                <div class="filter-group">
                    <label for="memberFilter"><i class="fas fa-user-friends"></i> Select View:</label>
                    <select id="memberFilter">
                        <option value="all">Community Overview</option>
                    </select>
                </div>
                <div class="rank-buttons">
                    <button id="showReturnRankBtn" class="btn-profit"><i class="fas fa-trophy"></i> Profit Ranking</button>
                    <button id="showScoreRankBtn" class="btn-score"><i class="fas fa-star"></i> Score Ranking</button>
                    <button id="showEligibilityRankBtn" class="btn-eligibility"><i class="fas fa-gavel"></i> Eligibility Ranking</button>
                </div>
            </div>

            <main class="main-content">
                <aside class="profile-card content-section" id="profileSection">
                    <div class="profile-image-container">
                        <img id="profileImage" src="https://i.postimg.cc/XNpR3cN1/20241030-065157.png" alt="Profile Picture">
                    </div>
                    <h2 id="profileName">Community</h2>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-coins icon-capital"></i> Total Capital</span>
                            <span class="value" id="profileTotalCapital">₹0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-arrow-up-from-bracket icon-loan"></i> Total Loan Given</span>
                            <span class="value negative" id="profileTotalLoan">₹0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-sack-dollar icon-profit"></i> Profit Distributed</span>
                            <span class="value positive" id="profileTotalProfit">₹0.00</span>
                        </div>
                        <div id="memberSpecificStats" class="hidden">
                             <div class="stat-item">
                                <span class="label"><i class="fas fa-star icon-score"></i> Performance Score</span>
                                <span class="value" id="profilePerformanceScore">0</span>
                            </div>
                             <div class="stat-item">
                                <span class="label"><i class="fas fa-gavel icon-limit"></i> Loan Eligibility</span>
                                <span class="value" id="profileLoanLimit">1.00x</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <div id="right-column">
                    <section id="growthChartSection" class="content-section">
                        <h2><i class="fas fa-chart-area"></i> Community Growth Over Time</h2>
                        <div id="growthChartContainer">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </section>

                    <section id="profitLogSection" class="content-section">
                        <h2><i class="fas fa-exchange-alt"></i> Profit Distribution Events</h2>
                        <div class="table-container">
                            <table id="profitLogTable">
                                <thead>
                                    <tr><th>Date</th><th>Payer</th><th>Loan Amt</th><th>Profit</th><th>Details</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <section id="memberHistorySection" class="content-section hidden">
                        <h2><i class="fas fa-history"></i> Member Transaction History</h2>
                         <div class="table-container">
                            <table id="memberHistoryTable">
                                <thead>
                                    <tr><th>Date</th><th>Type</th><th>Amount</th><th>Balance</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="detailsModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-chart-pie"></i> Profit Distribution</h2>
            <div class="chart-container"><canvas id="distributionChart"></canvas></div>
            <h3 class="list-header">Beneficiaries</h3>
            <div class="list-container"><ul id="distributionDetails"></ul></div>
        </div>
    </div>

    <div id="returnRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-trophy"></i> Member Profit Ranking</h2>
            <div class="list-container"><ol id="returnRankList"></ol></div>
        </div>
    </div>

    <div id="scoreRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-star"></i> Performance Score Ranking</h2>
            <div class="table-container list-container">
                <table id="scoreRankTable">
                    <thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="improvement-tips">
                <h4><i class="fas fa-lightbulb"></i> Score Kaise Badhaye?</h4>
                <ul>
                    <li>Har mahine 1 se 10 tarikh ke beech SIP jama karein.</li>
                    <li>Liye gaye loan ko samay par (90 din ke andar) chukayein.</li>
                    <li>System mein lambe samay tak apna capital banaye rakhein.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="eligibilityRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-gavel"></i> Loan Eligibility Ranking</h2>
            <div class="table-container list-container">
                <table id="eligibilityRankTable">
                    <thead><tr><th>Name</th><th>Capital</th><th>Eligibility</th><th>Max Loan Amt</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="calculationDetailsModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2 id="calculationDetailsTitle">Calculation Details</h2>
            <div id="calculationDetailsContent" class="list-container"></div>
        </div>
    </div>

    <div id="imageModal" class="modal visually-hidden">
         <button class="modal-close">×</button>
         <div class="modal-content"><img id="fullProfileImage" src="" alt="Full Profile Picture View"></div>
    </div>

    <!-- AI Explanation Modal -->
    <div id="aiExplainModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-robot"></i> AI Assistant</h2>
            <div id="aiExplanationContainer">
                <div id="languageToggleContainer" class="hidden">
                    <button class="lang-btn" data-lang="hi">हिंदी में</button>
                    <button class="lang-btn" data-lang="en">In English</button>
                </div>
                <div id="aiExplanationResult">
                    <!-- AI response will be appended here -->
                </div>
            </div>
        </div>
    </div>


<script>
// --- CONFIGURATION & NIYAM ---
const CONFIG = {
    // DATA_URL and PASSWORD are now handled by the backend
    DEFAULT_PROFILE_PIC: 'https://i.postimg.cc/XNpR3cN1/20241030-065157.png',
    CAPITAL_WEIGHT: 0.40, CONSISTENCY_WEIGHT: 0.30, CREDIT_BEHAVIOR_WEIGHT: 0.30,
    LOAN_LIMIT_TIER1_SCORE: 50, LOAN_LIMIT_TIER2_SCORE: 60, LOAN_LIMIT_TIER3_SCORE: 80,
    LOAN_LIMIT_TIER1_MAX: 1.0, LOAN_LIMIT_TIER2_MAX: 1.5, LOAN_LIMIT_TIER3_MAX: 1.8, LOAN_LIMIT_TIER4_MAX: 2.0,
    MINIMUM_MEMBERSHIP_DAYS: 60, SIP_ON_TIME_LIMIT: 10,
    LOAN_TERM_TIER3: 90, LOAN_TERM_LATE_FEE: 100,
    INACTIVE_MEMBER_DAYS_LIMIT: 365, 
    INACTIVE_MEMBER_PROFIT_MULTIPLIER: 0.75
};

// --- GLOBAL VARIABLES ---
let allData = [], memberNames = [], distributionChartInstance = null, growthChartInstance = null;
let CORRECT_PASSWORD = null;

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => setupPasswordPrompt());

async function setupPasswordPrompt() {
    const passwordContainer = document.getElementById('passwordPromptContainer');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmit = document.getElementById('passwordSubmit');
    
    try {
        // Fetch the PIN from the backend
        const response = await fetch('/api/getMembers');
        if (!response.ok) throw new Error("Could not connect to backend to get PIN.");
        const data = await response.json();
        CORRECT_PASSWORD = data.accessPin;
        if (!CORRECT_PASSWORD) {
            document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Access PIN not configured in backend.</div>`;
            return;
        }
        passwordContainer.classList.remove('visually-hidden');
        passwordInput.focus();
    } catch(e) {
        document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;">${e.message}</div>`;
        return;
    }

    const checkPassword = () => {
        if (passwordInput.value === CORRECT_PASSWORD) {
            passwordContainer.classList.add('visually-hidden');
            document.getElementById('loader').classList.remove('hidden');
            fetchData();
        } else {
            alert("Incorrect PIN");
            passwordInput.value = "";
            passwordInput.focus();
        }
    };
    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => e.key === 'Enter' && checkPassword());
}

// --- DATA FETCHING AND PROCESSING ---
async function fetchData() {
    try {
        const response = await fetch('/api/getMembers');
        if (!response.ok) throw new Error("Backend se data fetch karne mein samasya.");
        
        const jsonResponse = await response.json();
        allData = jsonResponse.transactions.map((row, index) => ({
            id: index, date: new Date(row.Date), name: String(row.Name).trim(),
            loan: parseFloat(row.Loan) || 0, payment: parseFloat(row.Payment) || 0,
            sipPayment: parseFloat(row.SipPayment) || 0, returnAmount: parseFloat(row.ReturnAmount) || 0,
            imageUrl: row.ImageUrl || null
        })).filter(r => r.name && !isNaN(r.date.getTime()));
        
        allData.sort((a, b) => a.date - b.date || a.id - b.id);
        memberNames = [...new Set(allData.map(row => row.name))].sort();
        initializeDashboard();
    } catch (error) {
        console.error("Error fetching data:", error);
        document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Failed to load data. Please refresh.</div>`;
    } finally {
        document.getElementById('loader').classList.add('hidden');
    }
}

// --- DASHBOARD SETUP ---
function initializeDashboard() {
    document.getElementById('dashboardContent').classList.remove('visually-hidden');
    document.getElementById('dashboardContent').classList.add('visible');
    populateMemberFilter();
    setupEventListeners();
    updateDisplay();
}

function setupEventListeners() {
    document.getElementById('memberFilter').addEventListener('change', updateDisplay);
    document.querySelectorAll('.modal').forEach(modal => {
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('visually-hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('visually-hidden') });
    });
    document.getElementById('showReturnRankBtn').addEventListener('click', displayReturnRanking);
    document.getElementById('showScoreRankBtn').addEventListener('click', displayScoreRanking);
    document.getElementById('showEligibilityRankBtn').addEventListener('click', displayEligibilityRanking);
    document.getElementById('profileImage').addEventListener('click', () => {
        const imageModal = document.getElementById('imageModal');
        const fullImage = document.getElementById('fullProfileImage');
        if(imageModal && fullImage) {
            fullImage.src = document.getElementById('profileImage').src;
            imageModal.classList.remove('visually-hidden');
        }
    });
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', handleLanguageToggle);
    });
}

function populateMemberFilter() {
    const nameFilter = document.getElementById("memberFilter");
    memberNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameFilter.appendChild(option);
    });
}

// --- CORE DISPLAY LOGIC ---
function updateDisplay() {
    const selectedName = document.getElementById('memberFilter').value;
    const isCommunityView = selectedName === 'all';

    document.getElementById('growthChartSection').classList.toggle('hidden', !isCommunityView);
    document.getElementById('profitLogSection').classList.toggle('hidden', !isCommunityView);
    document.getElementById('memberSpecificStats').classList.toggle('hidden', isCommunityView);
    document.getElementById('memberHistorySection').classList.toggle('hidden', isCommunityView);

    if (isCommunityView) {
        renderGrowthChart();
        populateProfitLog();
    } else {
        populateMemberHistory(selectedName);
    }
    updateProfileCard(selectedName);
}

function updateProfileCard(name) {
    const profileImageEl = document.getElementById('profileImage');
    const profileNameEl = document.getElementById('profileName');
    let totalCapital = 0, totalLoan = 0, totalProfitEarned = 0;

    if (name === 'all') {
        allData.forEach(r => {
            totalCapital += r.sipPayment + r.payment - r.loan;
            totalLoan += r.loan;
        });
        totalProfitEarned = allData.reduce((sum, r) => sum + r.returnAmount, 0);
        profileNameEl.textContent = 'Community Overview';
        profileImageEl.src = CONFIG.DEFAULT_PROFILE_PIC;
    } else {
        const dataToShow = allData.filter(r => r.name === name);
        totalCapital = dataToShow.reduce((sum, r) => sum + r.sipPayment + r.payment - r.loan, 0);
        totalLoan = dataToShow.reduce((sum, r) => sum + r.loan, 0);
        totalProfitEarned = calculateTotalProfitForMember(name);

        const memberScores = calculatePerformanceScore(name, new Date());
        const score = memberScores.totalScore;
        const loanEligibility = getLoanEligibility(name, score);

        document.getElementById('profilePerformanceScore').textContent = score.toFixed(2);
        const limitEl = document.getElementById('profileLoanLimit');
        if(loanEligibility.eligible) {
            limitEl.textContent = `${loanEligibility.multiplier.toFixed(2)}x`;
            limitEl.classList.remove('negative');
        } else {
            limitEl.textContent = loanEligibility.reason;
            limitEl.classList.add('negative');
        }
        
        profileNameEl.textContent = name;
        const lastUserEntryWithImage = [...dataToShow].reverse().find(r => r.imageUrl);
        profileImageEl.src = lastUserEntryWithImage ? lastUserEntryWithImage.imageUrl : CONFIG.DEFAULT_PROFILE_PIC;
    }
    
    document.getElementById('profileTotalCapital').textContent = `₹${totalCapital.toFixed(2)}`;
    document.getElementById('profileTotalLoan').textContent = `₹${totalLoan.toFixed(2)}`;
    document.getElementById('profileTotalProfit').textContent = `₹${totalProfitEarned.toFixed(2)}`;
}

// --- PERFORMANCE SCORE ENGINE ---
function calculatePerformanceScore(memberName, untilDate) {
    const data = allData.filter(r => r.date <= untilDate);
    const memberData = data.filter(r => r.name === memberName);
    if (memberData.length === 0) return { totalScore: 0, capitalScore: 0, consistencyScore: 0, creditScore: 0 };

    const totalDays = 180;
    const startDate = new Date(untilDate.getTime() - totalDays * 24 * 3600 * 1000);
    let weightedCapitalSum = 0, currentBalance = 0;
    const relevantTransactions = memberData.filter(r => r.date >= startDate);
    if (relevantTransactions.length > 0) {
        let lastDate = startDate;
        relevantTransactions.forEach(t => {
            const daysDifference = (t.date - lastDate) / (1000 * 3600 * 24);
            weightedCapitalSum += currentBalance * daysDifference;
            currentBalance += t.sipPayment + t.payment - t.loan;
            lastDate = t.date;
        });
        weightedCapitalSum += currentBalance * ((untilDate - lastDate) / (1000 * 3600 * 24));
    }
    const capitalScore = Math.max(0, weightedCapitalSum / totalDays);
    const normalizedCapitalScore = Math.min(100, (capitalScore / 50000) * 100);

    const sipHistory = {};
    memberData.filter(r => r.sipPayment > 0).forEach(r => {
        const monthKey = `${r.date.getFullYear()}-${r.date.getMonth()}`;
        if (!sipHistory[monthKey]) sipHistory[monthKey] = r.date.getDate() <= CONFIG.SIP_ON_TIME_LIMIT ? 10 : 5;
    });
    const consistencyPoints = Object.values(sipHistory).reduce((a, b) => a + b, 0);
    const monthsConsidered = Math.max(1, Object.keys(sipHistory).length);
    const consistencyScore = (consistencyPoints / (monthsConsidered * 10)) * 100;

    let creditPoints = 0;
    const memberLoans = memberData.filter(r => r.loan > 0);
    memberLoans.forEach(loanRecord => {
        const repayment = memberData.find(r => r.payment >= loanRecord.loan && r.date > loanRecord.date);
        if (repayment) {
            const daysToRepay = (repayment.date - loanRecord.date) / (1000 * 3600 * 24);
            if (daysToRepay <= CONFIG.LOAN_TERM_TIER3) creditPoints += 20;
            else if (daysToRepay <= CONFIG.LOAN_TERM_LATE_FEE) creditPoints -= 5;
            else creditPoints -= 30;
        } else { creditPoints -= 40; }
    });
    const creditScore = memberLoans.length > 0 ? Math.max(0, (creditPoints / (memberLoans.length * 20)) * 100) : 70;

    const totalScore = (normalizedCapitalScore * CONFIG.CAPITAL_WEIGHT) + (consistencyScore * CONFIG.CONSISTENCY_WEIGHT) + (creditScore * CONFIG.CREDIT_BEHAVIOR_WEIGHT);
    return { totalScore, capitalScore: normalizedCapitalScore, consistencyScore, creditScore };
}

function getLoanEligibility(memberName, score) {
    const memberData = allData.filter(r => r.name === memberName);
    const totalLoan = memberData.reduce((sum, r) => sum + r.loan, 0);
    const totalPayment = memberData.reduce((sum, r) => sum + r.payment + r.sipPayment, 0); 
    if (totalLoan > totalPayment) {
        return { eligible: false, reason: 'Outstanding Loan' };
    }

    const firstSip = memberData.find(r => r.sipPayment > 0);
    if (!firstSip) {
        return { eligible: false, reason: 'No SIP yet' };
    }
    const daysSinceFirstSip = (new Date() - firstSip.date) / (1000 * 3600 * 24);
    if (daysSinceFirstSip < CONFIG.MINIMUM_MEMBERSHIP_DAYS) {
        const daysLeft = Math.ceil(CONFIG.MINIMUM_MEMBERSHIP_DAYS - daysSinceFirstSip);
        return { eligible: false, reason: `${daysLeft} days left` };
    }

    const { LOAN_LIMIT_TIER1_SCORE, LOAN_LIMIT_TIER2_SCORE, LOAN_LIMIT_TIER3_SCORE, LOAN_LIMIT_TIER1_MAX, LOAN_LIMIT_TIER2_MAX, LOAN_LIMIT_TIER3_MAX, LOAN_LIMIT_TIER4_MAX } = CONFIG;
    let multiplier = LOAN_LIMIT_TIER1_MAX;
    if (score < LOAN_LIMIT_TIER1_SCORE) {
        multiplier = LOAN_LIMIT_TIER1_MAX;
    } else if (score < LOAN_LIMIT_TIER2_SCORE) {
        multiplier = LOAN_LIMIT_TIER1_MAX + ((score - LOAN_LIMIT_TIER1_SCORE) / (LOAN_LIMIT_TIER2_SCORE - LOAN_LIMIT_TIER1_SCORE)) * (LOAN_LIMIT_TIER2_MAX - LOAN_LIMIT_TIER1_MAX);
    } else if (score < LOAN_LIMIT_TIER3_SCORE) {
        multiplier = LOAN_LIMIT_TIER2_MAX + ((score - LOAN_LIMIT_TIER2_SCORE) / (LOAN_LIMIT_TIER3_SCORE - LOAN_LIMIT_TIER2_SCORE)) * (LOAN_LIMIT_TIER3_MAX - LOAN_LIMIT_TIER2_MAX);
    } else {
        multiplier = LOAN_LIMIT_TIER3_MAX + ((score - LOAN_LIMIT_TIER3_SCORE) / (100 - LOAN_LIMIT_TIER3_SCORE)) * (LOAN_LIMIT_TIER4_MAX - LOAN_LIMIT_TIER3_MAX);
    }
    
    return { eligible: true, multiplier: Math.max(LOAN_LIMIT_TIER1_MAX, multiplier) };
}

// --- PROFIT & HISTORY LOGIC ---
function populateProfitLog() {
    const tableBody = document.querySelector("#profitLogTable tbody");
    tableBody.innerHTML = '';
    const profitEvents = allData.filter(r => r.returnAmount > 0);
    if (profitEvents.length === 0) {
        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="5">No profit events found.</td></tr>`;
        return;
    }
    profitEvents.forEach(paymentRecord => {
        const result = calculateProfitDistribution(paymentRecord);
        if (result && result.profit > 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${formatDate(paymentRecord.date)}</td><td>${paymentRecord.name}</td><td>₹${result.relevantLoan.loan.toFixed(2)}</td><td class="profit-value">₹${result.profit.toFixed(2)}</td><td><button class="details-btn">View</button></td>`;
            row.querySelector('.details-btn').addEventListener('click', () => showDistributionModal(result));
            tableBody.appendChild(row);
        }
    });
}

function populateMemberHistory(memberName) {
    const tableBody = document.querySelector("#memberHistoryTable tbody");
    tableBody.innerHTML = '';
    const memberData = allData.filter(r => r.name === memberName);
    let balance = 0;
    if (memberData.length === 0) {
        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="4">No transaction history found.</td></tr>`;
        return;
    }
    memberData.forEach(r => {
        let type = '', amount = 0, sign = '';
        if (r.sipPayment > 0) { type = 'sip'; amount = r.sipPayment; balance += amount; sign = '+'; }
        else if (r.loan > 0) { type = 'loan'; amount = r.loan; balance -= amount; sign = '-'; }
        else if (r.payment > 0) { type = 'payment'; amount = r.payment; balance += amount; sign = '+'; }
        else return;

        const row = document.createElement('tr');
        row.innerHTML = `<td>${formatDate(r.date)}</td><td class="transaction-type ${type}">${type.toUpperCase()}</td><td>${sign} ₹${amount.toFixed(2)}</td><td>₹${balance.toFixed(2)}</td>`;
        tableBody.appendChild(row);
    });
}

function calculateTotalProfitForMember(memberName) {
    return allData.reduce((totalProfit, transaction) => {
        if (transaction.returnAmount > 0) {
            const result = calculateProfitDistribution(transaction);
            const memberShare = result?.distribution.find(d => d.name === memberName);
            if (memberShare) totalProfit += memberShare.share;
        }
        return totalProfit;
    }, 0);
}

function calculateProfitDistribution(paymentRecord) {
    const profit = paymentRecord.returnAmount;
    if (profit <= 0) return null;
    const userLoansBeforePayment = allData.filter(r => r.name === paymentRecord.name && r.loan > 0 && r.date < paymentRecord.date);
    if (userLoansBeforePayment.length === 0) return null; 
    const relevantLoan = userLoansBeforePayment[userLoansBeforePayment.length - 1];
    const loanDate = relevantLoan.date;

    const snapshotScores = {};
    let totalScoreInSnapshot = 0;
    const membersInSystemAtLoanDate = [...new Set(allData.filter(r => r.date <= loanDate).map(r => r.name))];

    membersInSystemAtLoanDate.forEach(name => {
        const scoreObject = calculatePerformanceScore(name, loanDate);
        if (scoreObject.totalScore > 0) {
            snapshotScores[name] = scoreObject;
            totalScoreInSnapshot += scoreObject.totalScore;
        }
    });
    if (totalScoreInSnapshot <= 0) return null;

    const distribution = [];
    for (const memberName in snapshotScores) {
        let memberShare = (snapshotScores[memberName].totalScore / totalScoreInSnapshot) * profit;
        const lastLoanDate = allData.filter(r => r.name === memberName && r.loan > 0 && r.date <= loanDate).pop()?.date;
        const daysSinceLastLoan = lastLoanDate ? (loanDate - lastLoanDate) / (1000 * 3600 * 24) : Infinity;
        let appliedMultiplier = 1;
        if (daysSinceLastLoan > CONFIG.INACTIVE_MEMBER_DAYS_LIMIT) {
            memberShare *= CONFIG.INACTIVE_MEMBER_PROFIT_MULTIPLIER;
            appliedMultiplier = CONFIG.INACTIVE_MEMBER_PROFIT_MULTIPLIER;
        }
        if (memberShare > 0) distribution.push({ 
            name: memberName, share: memberShare,
            snapshotScore: snapshotScores[memberName].totalScore,
            totalSnapshotScore: totalScoreInSnapshot,
            multiplier: appliedMultiplier
        });
    }
    return { profit, relevantLoan, distribution: distribution.sort((a,b) => b.share - a.share) };
}

// --- RANKING MODALS ---
function displayReturnRanking() {
    const listEl = document.getElementById('returnRankList');
    let memberProfits = memberNames.map(name => ({ name: name, totalProfit: calculateTotalProfitForMember(name) }))
        .filter(member => member.totalProfit > 0).sort((a, b) => b.totalProfit - a.totalProfit);
    listEl.innerHTML = '';
    if (memberProfits.length === 0) listEl.innerHTML = '<li>No members have earned a return yet.</li>';
    else memberProfits.forEach((member, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="rank">${index + 1}.</span><span class="name">${member.name}</span><span class="share">+ ₹${member.totalProfit.toFixed(2)}</span>
                        <div class="button-group">
                            <button class="btn-details-small">Details</button>
                            <button class="btn-ai-small"><i class="fas fa-robot"></i> AI</button>
                        </div>`;
        li.querySelector('.btn-details-small').addEventListener('click', () => showCalculationDetails({type: 'total_profit', memberName: member.name}));
        li.querySelector('.btn-ai-small').addEventListener('click', () => {
             const promptGenerator = () => {
                let profitBreakdown = '';
                allData.filter(r => r.returnAmount > 0).forEach(event => {
                    const result = calculateProfitDistribution(event);
                    const share = result?.distribution.find(d => d.name === member.name);
                    if (share) {
                        profitBreakdown += `\n- ${event.name} ke loan (Date: ${formatDate(event.date)}) se mila profit: ₹${share.share.toFixed(2)}.`;
                    }
                });
                return `Tum ek financial advisor ho. Member '${member.name}' ko mile total profit (₹${member.totalProfit.toFixed(2)}) ko aasan Hindi me samjhao. Unhe yeh profit kahan kahan se mila, iska breakdown do. Data:\n${profitBreakdown}`;
            };
            generateAndShowExplanation(promptGenerator);
        });
        listEl.appendChild(li);
    });
    document.getElementById('returnRankModal').classList.remove('visually-hidden');
}

function displayScoreRanking() {
    const tableBody = document.querySelector("#scoreRankTable tbody");
    let memberScores = memberNames.map(name => ({ name, scores: calculatePerformanceScore(name, new Date()) }))
        .sort((a, b) => b.scores.totalScore - a.scores.totalScore);
    tableBody.innerHTML = '';
    memberScores.forEach((member, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${index + 1}</td>
                         <td>${member.name}</td>
                         <td>${member.scores.totalScore.toFixed(2)}</td>
                         <td>
                            <div class="button-group">
                                <button class="btn-details-small">Details</button>
                                <button class="btn-ai-small"><i class="fas fa-robot"></i> AI</button>
                            </div>
                         </td>`;
        row.querySelector('.btn-details-small').addEventListener('click', () => showCalculationDetails({type: 'score', member: member}));
        row.querySelector('.btn-ai-small').addEventListener('click', () => {
            const promptGenerator = () => {
                const { name, scores } = member;
                return `Tum ek financial advisor ho. Member '${name}' ka performance score ${scores.totalScore.toFixed(2)} hai. Is score ko aasan Hindi me samjhao.
                Batao ki yeh score in teen cheezon se milkar bana hai:
                1.  Capital Score: ${scores.capitalScore.toFixed(2)} (Weight: 40%) - Yeh score batata hai ki member ne kitna paisa system me rakha hai.
                2.  Consistency Score: ${scores.consistencyScore.toFixed(2)} (Weight: 30%) - Yeh score batata hai ki member har mahine samay par SIP jama karta hai ya nahi.
                3.  Credit Score: ${scores.creditScore.toFixed(2)} (Weight: 30%) - Yeh score batata hai ki member liye gaye loan ko samay par chukata hai ya nahi.
                Finally, yeh bhi batao ki woh apna score kaise sudhar sakte hain.`;
            };
            generateAndShowExplanation(promptGenerator);
        });
        tableBody.appendChild(row);
    });
    document.getElementById('scoreRankModal').classList.remove('visually-hidden');
}

function displayEligibilityRanking() {
    const tableBody = document.querySelector("#eligibilityRankTable tbody");
    let memberEligibility = memberNames.map(name => {
        const capital = allData.filter(r => r.name === name).reduce((sum, r) => sum + r.sipPayment + r.payment - r.loan, 0);
        const score = calculatePerformanceScore(name, new Date()).totalScore;
        const eligibility = getLoanEligibility(name, score);
        return { name, capital, score, eligibility, maxLoan: eligibility.eligible ? capital * eligibility.multiplier : 0 };
    }).sort((a, b) => b.maxLoan - a.maxLoan);
    tableBody.innerHTML = '';
    memberEligibility.forEach(member => {
        const row = document.createElement('tr');
        let eligibilityText = '';
        if (member.eligibility.eligible) {
            eligibilityText = `${member.eligibility.multiplier.toFixed(2)}x`;
        } else {
            eligibilityText = `<span class="negative">${member.eligibility.reason}</span>`;
        }
        row.innerHTML = `<td>${member.name}</td>
                         <td>₹${member.capital.toFixed(2)}</td>
                         <td>${eligibilityText}</td>
                         <td>₹${member.maxLoan.toFixed(2)}</td>
                         <td>
                            <div class="button-group">
                                <button class="btn-details-small">Details</button>
                                <button class="btn-ai-small"><i class="fas fa-robot"></i> AI</button>
                            </div>
                         </td>`;
        row.querySelector('.btn-details-small').addEventListener('click', () => showCalculationDetails({type: 'eligibility', member: member}));
        row.querySelector('.btn-ai-small').addEventListener('click', () => {
            const promptGenerator = () => {
                const { name, capital, score, eligibility, maxLoan } = member;
                if (eligibility.eligible) {
                    return `Tum ek financial advisor ho. Member '${name}' ki loan eligibility ko aasan Hindi me samjhao.
                    Data:
                    - Capital: ₹${capital.toFixed(2)}
                    - Performance Score: ${score.toFixed(2)}
                    - Eligibility Multiplier: ${eligibility.multiplier.toFixed(2)}x
                    - Max Loan Amount: ₹${maxLoan.toFixed(2)}
                    Samjhao ki unka multiplier unke score par depend karta hai, aur isliye woh apne capital ka ${eligibility.multiplier.toFixed(2)} guna tak loan le sakte hain.`;
                } else {
                    return `Tum ek financial advisor ho. Member '${name}' abhi loan ke liye eligible kyun nahi hai, yeh aasan Hindi me samjhao.
                    Karan: ${eligibility.reason}. Is karan ka matlab samjhao. Jaise, 'Outstanding Loan' ka matlab hai ki unka purana loan abhi baki hai.`;
                }
            };
            generateAndShowExplanation(promptGenerator);
        });
        tableBody.appendChild(row);
    });
    document.getElementById('eligibilityRankModal').classList.remove('visually-hidden');
}

// --- DETAILS & CHARTING FUNCTIONS ---
function showCalculationDetails(details) {
    const titleEl = document.getElementById('calculationDetailsTitle');
    const contentEl = document.getElementById('calculationDetailsContent');
    let html = '';

    if (details.type === 'score') {
        const { name, scores } = details.member;
        titleEl.textContent = `Score Calculation for ${name}`;
        html = `
            <div class="calc-row"><span class="calc-label">Capital Score</span> <span class="calc-value">${scores.capitalScore.toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Consistency Score</span> <span class="calc-value">${scores.consistencyScore.toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Credit Behavior Score</span> <span class="calc-value">${scores.creditScore.toFixed(2)}</span></div>
            <hr>
            <div class="calc-row"><span class="calc-label">Weighted Capital (40%)</span> <span class="calc-value">${(scores.capitalScore * CONFIG.CAPITAL_WEIGHT).toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Weighted Consistency (30%)</span> <span class="calc-value">${(scores.consistencyScore * CONFIG.CONSISTENCY_WEIGHT).toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Weighted Credit (30%)</span> <span class="calc-value">${(scores.creditScore * CONFIG.CREDIT_BEHAVIOR_WEIGHT).toFixed(2)}</span></div>
            <div class="calc-final">Total Score: ${scores.totalScore.toFixed(2)}</div>
        `;
    } else if (details.type === 'profit_event') {
        const { member, profitEvent } = details;
        titleEl.textContent = `Profit Share for ${member.name}`;
        const sharePercentage = (member.snapshotScore / member.totalSnapshotScore) * 100;
        const initialShare = (sharePercentage / 100) * profitEvent.profit;
        html = `
            <div class="calc-row"><span class="calc-label">Loan From</span> <span class="calc-value">${profitEvent.relevantLoan.name}</span></div>
            <div class="calc-row"><span class="calc-label">Total Profit from Loan</span> <span class="calc-value">₹${profitEvent.profit.toFixed(2)}</span></div>
            <hr>
            <div class="calc-row"><span class="calc-label">Your Score (at loan time)</span> <span class="calc-value">${member.snapshotScore.toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Total Community Score</span> <span class="calc-value">${member.totalSnapshotScore.toFixed(2)}</span></div>
            <div class="calc-row"><span class="calc-label">Your Share (%)</span> <span class="calc-value">${sharePercentage.toFixed(2)}%</span></div>
            <div class="calc-formula">(Your Score / Total Score) * 100</div>
            <hr>
            <div class="calc-row"><span class="calc-label">Initial Share</span> <span class="calc-value">₹${initialShare.toFixed(2)}</span></div>
            ${member.multiplier !== 1 ? `<div class="calc-row"><span class="calc-label">Inactive Policy (x${member.multiplier})</span> <span class="calc-value">- ₹${(initialShare - member.share).toFixed(2)}</span></div>` : ''}
            <div class="calc-final">Final Profit: ₹${member.share.toFixed(2)}</div>
        `;
    } else if (details.type === 'total_profit') {
        titleEl.textContent = `Total Profit for ${details.memberName}`;
        let profitBreakdownHtml = '';
        let totalProfit = 0;
        allData.filter(r => r.returnAmount > 0).forEach(event => {
            const result = calculateProfitDistribution(event);
            const share = result?.distribution.find(d => d.name === details.memberName);
            if (share) {
                totalProfit += share.share;
                profitBreakdownHtml += `<div class="calc-row"><span class="calc-label">From ${event.name}'s loan (${formatDate(event.date)})</span> <span class="calc-value">+ ₹${share.share.toFixed(2)}</span></div>`;
            }
        });
        if (!profitBreakdownHtml) profitBreakdownHtml = '<div class="calc-row"><span class="calc-label">No profit earned yet.</span></div>';
        html = `${profitBreakdownHtml}<div class="calc-final">Total Profit: ₹${totalProfit.toFixed(2)}</div>`;
    } else if (details.type === 'eligibility') {
        const { name, score, eligibility } = details.member;
        titleEl.textContent = `Eligibility for ${name}`;
        if(eligibility.eligible) {
            html = `
                <div class="calc-row"><span class="calc-label">Your Performance Score</span> <span class="calc-value">${score.toFixed(2)}</span></div>
                <hr>
                <p style="font-size:0.9em; text-align:center; color: var(--text-light);">Aapka multiplier aapke score ke aadhar par scale hota hai.</p>
                <div class="calc-final">Your Multiplier: ${eligibility.multiplier.toFixed(2)}x</div>
            `;
        } else {
             html = `<div class="calc-final" style="color:var(--negative-color);">${eligibility.reason}</div>`;
        }
    }

    contentEl.innerHTML = html;
    document.getElementById('calculationDetailsModal').classList.remove('visually-hidden');
}

function renderGrowthChart() {
    const ctx = document.getElementById('growthChart').getContext('2d');
    const growthData = calculateGrowthData();
    if (growthChartInstance) growthChartInstance.destroy();
    growthChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: growthData.labels,
            datasets: [
                { label: 'Total Capital', data: growthData.capital, borderColor: 'rgba(52, 152, 219, 1)', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.1 },
                { label: 'Total Loans', data: growthData.loans, borderColor: 'rgba(231, 76, 60, 1)', backgroundColor: 'rgba(231, 76, 60, 0.1)', fill: true, tension: 0.1 },
                { label: 'Total Profit', data: growthData.profits, borderColor: 'rgba(39, 174, 96, 1)', backgroundColor: 'rgba(39, 174, 96, 0.1)', fill: true, tension: 0.1 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => `₹${value}` } } }, plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ₹${context.parsed.y.toFixed(2)}` } } } }
    });
}
function calculateGrowthData() {
    const snapshots = {}; let cumulativeCapital = 0, cumulativeLoan = 0, cumulativeProfit = 0;
    allData.forEach(r => {
        cumulativeCapital += r.sipPayment + r.payment - r.loan; cumulativeLoan += r.loan; cumulativeProfit += r.returnAmount;
        const monthKey = r.date.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
        snapshots[monthKey] = { capital: cumulativeCapital, loans: cumulativeLoan, profits: cumulativeProfit, date: new Date(r.date.getFullYear(), r.date.getMonth(), 1) };
    });
    const sortedKeys = Object.keys(snapshots).sort((a,b) => snapshots[a].date - snapshots[b].date);
    return { labels: sortedKeys, capital: sortedKeys.map(key => snapshots[key].capital), loans: sortedKeys.map(key => snapshots[key].loans), profits: sortedKeys.map(key => snapshots[key].profits) };
}
function showDistributionModal(profitEvent) {
    const modal = document.getElementById('detailsModal'); const listEl = document.getElementById('distributionDetails'); listEl.innerHTML = '';
    const ctx = document.getElementById('distributionChart').getContext('2d');
    if (distributionChartInstance) distributionChartInstance.destroy();
    
    const distributionData = profitEvent.distribution;
    if (!distributionData || distributionData.length === 0) { listEl.innerHTML = '<li>No beneficiaries found for this event.</li>'; } 
    else {
        const labels = distributionData.map(d => d.name); const data = distributionData.map(d => d.share.toFixed(2));
        distributionData.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="name">${item.name}</span><span class="share">+ ₹${item.share.toFixed(2)}</span>
                            <div class="button-group">
                                <button class="btn-details-small">Details</button>
                                <button class="btn-ai-small"><i class="fas fa-robot"></i> AI</button>
                            </div>`;
            li.querySelector('.btn-details-small').addEventListener('click', () => showCalculationDetails({type: 'profit_event', member: item, profitEvent: profitEvent}));
            li.querySelector('.btn-ai-small').addEventListener('click', () => {
                const promptGenerator = () => {
                     return `Tum ek financial advisor ho. Member '${item.name}' ko ${profitEvent.relevantLoan.name} ke loan se ₹${item.share.toFixed(2)} ka profit kyu mila? Aasan Hindi me samjhao.
                    Data:
                    - Loan lene wale ka naam: ${profitEvent.relevantLoan.name}
                    - Total profit jo is loan se hua: ₹${profitEvent.profit.toFixed(2)}
                    - Jab loan diya gaya tha, tab '${item.name}' ka score: ${item.snapshotScore.toFixed(2)}
                    - Us samay sabhi members ka total score: ${item.totalSnapshotScore.toFixed(2)}
                    Samjhao ki unka hissa unke score ke anupat me milta hai. Agar unka 'inactive policy multiplier' 1 se kam hai, to yeh bhi batao ki unka share kyu kata gaya. Multiplier: ${item.multiplier}`;
                };
                generateAndShowExplanation(promptGenerator);
            });
            listEl.appendChild(li);
        });
        distributionChartInstance = new Chart(ctx, {
            type: 'bar', data: { labels, datasets: [{ label: 'Profit Share (₹)', data, backgroundColor: 'rgba(52, 152, 219, 0.7)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 1 }] },
            options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true, title: { display: true, text: 'Amount (₹)' } } }, plugins: { legend: { display: false } } }
        });
    }
    modal.classList.remove('visually-hidden');
}

function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return "N/A"; return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); } 
</script>
</body>
</html>

